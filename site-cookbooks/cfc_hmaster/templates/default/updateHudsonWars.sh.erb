#!/bin/sh

#Script to update the existing hudson wars with the new template. Container should already be stopped

HUDSON_BASE_DIR=<%= node.cfc.hmaster.builds_dir %>/
HUDSON_TEMPLATE_WAR=<%= node.cfc.server.opt %>/configuration/template/hudson-war/hudson.war
HUDSON_WEBAPPS_DIR=<%= node.cfc.server.opt %>/webapps

EXISTING_WEBAPPS=`ls $HUDSON_WEBAPPS_DIR/*hudson.war`

echo 'removing users plugin data'
rm -rf $HUDSON_BASE_DIR/*/plugins/*

echo 'removing existing webapps'
rm -rf $HUDSON_WEBAPPS_DIR/*hudson

for WEBAPP in $EXISTING_WEBAPPS
do
	<% if node.cfc.hub.prefix_path = "" -%>
    APPID=${WEBAPP#$HUDSON_WEBAPPS_DIR/s#}
    <% else -%>
    APPID=${WEBAPP#$HUDSON_WEBAPPS_DIR<%= node.cfc.hub.prefix_path %>#s#}
    <% end -%>
    APPID=${APPID%#hudson.war}

    echo Updating webapp $WEBAPP for app $APPID

    TEMP_WAR_LOCATION=/tmp/hudson-$APPID
    mkdir $TEMP_WAR_LOCATION
    cp $HUDSON_TEMPLATE_WAR $TEMP_WAR_LOCATION
    cd $TEMP_WAR_LOCATION
    jar -xf hudson.war WEB-INF/web.xml
    
    # Place the hudson home for this app in the web.xml
    sed "s,<env-entry-value>,<env-entry-value>$HUDSON_BASE_DIR$APPID ," WEB-INF/web.xml > WEB-INF/web.xml.mod
    mv  WEB-INF/web.xml.mod  WEB-INF/web.xml

    jar -uf hudson.war WEB-INF/web.xml
    mv hudson.war $WEBAPP
    chown <%= node.cfc.user %>:<%= node.cfc.user %> $WEBAPP 
    rm -rf $TEMP_WAR_LOCATION
done


